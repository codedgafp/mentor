define(["jquery","jqueryui","core/modal_factory","core/templates","core/modal_events","tool_adhoctasksqueue/datatables","tool_adhoctasksqueue/datatables-buttons","tool_adhoctasksqueue/datatables-select","tool_adhoctasksqueue/datatables-checkboxes"],function(o,t,s,e,i){var a={api_url:M.cfg.wwwroot+"/admin/tool/adhoctasksqueue/ajax/ajax.php",modalElement:o("#modal"),tableElement:o("#taskslist"),loadingSpinner:o("#loading-spinner"),init:function(){var t=this;this.loadTasks(),this.tableElement.on("click",".see-customdata",function(){t.customData(o(this).data("id"))}),this.tableElement.on("click",".deletetask i",function(){t.confirmDeleteTask(o(this).data("id"))})},loadTasks:function(){var e=this;this.tableElement.on("xhr.dt",function(t,e,a,n){if(n.status<200||300<=n.status){let t={};t.type=s.types.DEFAULT,t.title=n.responseJSON?"Error "+n.responseJSON.status:n.status,t.body=n.responseJSON?n.responseJSON.message:n.statusText,s.create(t,this.modalElement).done(function(t){t.show()})}}).DataTable({oLanguage:{sUrl:M.cfg.wwwroot+"/admin/tool/adhoctasksqueue/datatables/lang/"+M.util.get_string("langfile","tool_adhoctasksqueue")+".json"},ajax:{url:this.api_url+"?action=get_tasks",dataSrc:"tasks"},columns:[{data:"id"},{data:"component"},{data:"classname"},{data:"nextruntime",render:function(t,e){return"display"===e?new Date(1e3*t).toLocaleString():t}},{data:"faildelay"},{data:"id",orderable:!1,render:function(t,e){return'<i class="fa fa-search see-customdata" data-id="'+t+'"></i>'}},{data:"userid",render:function(t,e,a){return null===a.userid?'<i class="fa fa-ban"></i>':"<a href='"+M.cfg.wwwroot+"/user/profile.php?id="+a.userid+"'>"+a.userfullname+"</a>"}},{data:"blocking"},{data:"id",className:"deletetask",orderable:!1,render:function(t,e,a,n){return'<i class="fa fa-remove removetask" data-id="'+t+'" aria-hidden="true"></i>'}}],drawCallback:function(t){e.loadingSpinner.hide()}})},customData:async function(t){var n=this;this.loadingSpinner.show(),o.getJSON(this.api_url+"?action=get_customdata&id="+t,function(e){let t={};t.type=s.types.DEFAULT;let a;try{a=JSON.parse(e.customdata)}catch(t){a=e.customdata}"object"==typeof a?(t.title=n.getString("customdatacontent"),null===a?t.body=n.getString("nocustomdata"):(e="",e+=n.render(a),t.body=e)):(t.title=n.getString("customdatacontentnojson"),t.body=a),s.create(t,n.modalElement).done(function(t){n.loadingSpinner.hide(),t.show()})}).fail(function(t){s.create({type:s.types.DEFAULT,title:n.getString("error")+" "+t.status,body:t.responseJSON.message},n.modalElement).done(function(t){n.loadingSpinner.hide(),t.show()})})},confirmDeleteTask:async function(a){var n=this;s.create({type:s.types.SAVE_CANCEL,title:this.getString("deletetask"),body:this.getString("deletetaskquestion",a)},this.modalElement).done(function(e){e.show(),e.getRoot().on(i.save,async function(t){n.deleteTask(a,e)})})},deleteTask:async function(e,a){var n=this;this.loadingSpinner.show(),o.getJSON(this.api_url+"?action=delete_task&id="+e,function(t){a.hide(),n.tableElement.DataTable().ajax.reload(function(){n.loadingSpinner.hide()})}).fail(function(t){s.create({type:s.types.DEFAULT,title:n.getString("error")+" "+t.status,body:n.getString("deletetaskerror",e)+"<br>("+t.responseJSON.message+")"},n.modalElement).done(function(t){t.show(),n.tableElement.DataTable().ajax.reload(function(){n.loadingSpinner.hide()})})})},render:function(t){let e="<ul>";for(const n in t){var a=t[n];e=(e+="<li>"+n+" :")+("object"==typeof a?this.render(a):a)+"</li>"}return e+="</ul>"},getString:function(t,e){return"string"!=typeof M.str.tool_adhoctasksqueue[t]?t+": Intl error":M.util.get_string(t,"tool_adhoctasksqueue",e)}};return window.tool_adhoc=a});